[values]
LinbitSigningKey = "https://packages.linbit.com/package-signing-pubkey.asc"
LinbitPackageRepoLine = "https://packages.linbit.com/piraeus buster drbd-9"

[[steps]]
[steps.rsync]
source = "./out/test/csi-sanity-test"
dest = "/opt/testbin/"

[[steps]]
[steps.rsync]
source = "./test/sanity/params.yaml"
dest = "/opt/testdata/"

[[steps]]
[steps.shell]
script = """
set -ex

curl -fsSL "$LINBIT_SIGNING_KEY" | apt-key add -
echo "deb $LINBIT_PACKAGE_REPO_LINE" > /etc/apt/sources.list.d/linbit.list

apt-get update
apt-get install -y linstor-controller linstor-satellite linstor-client drbd-module-$(uname -r) drbd-utils

systemctl start linstor-controller linstor-satellite

while ! linstor controller version >/dev/null 2>&1 ; do
    echo Waiting for LINSTOR Controller to come online...
    sleep 5
done

linstor node create --node-type satellite "$(hostname -f)" "$(hostname -I)"

while ! linstor -m --output-version v1 node list -n "$(hostname -f)" | grep "ONLINE" >/dev/null 2>&1 ; do
    echo Waiting for LINSTOR Controller...
    sleep 5
done

linstor physical-storage create-device-pool --pool-name sanity --storage-pool sanity-test lvmthin "$(hostname -f)" /dev/vdb


/opt/testbin/csi-sanity-test -sanity.linstor-endpoint "http://localhost:3370" -sanity.mount-for-real -sanity.node "$(hostname -f)" -sanity.parameter-file /opt/testdata/params.yaml -sanity.junitfile /sanity-report.xml -ginkgo.failFast
"""
[steps.shell.env]
LINBIT_SIGNING_KEY = "{{ .LinbitSigningKey }}"
LINBIT_PACKAGE_REPO_LINE = "{{ .LinbitPackageRepoLine }}"
